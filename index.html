<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Runner: Re-Engineered</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #0d0c1d;
            font-family: 'Orbitron', sans-serif;
            color: #e0e1dd;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            background: #1a1a2e;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
            border: 2px solid #30475e;
            border-radius: 10px;
            overflow: hidden; /* Added to contain child elements */
        }

        #gameArea {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            perspective: 1000px;
        }

        .grid {
            position: absolute;
            width: 120%;
            height: 200%;
            left: -10%;
            top: -50%;
            background-image:
                linear-gradient(to right, rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: rotateX(80deg);
            animation: moveGrid 10s linear infinite;
        }

        @keyframes moveGrid {
            0% {
                transform: rotateX(80deg) translateY(0);
            }
            100% {
                transform: rotateX(80deg) translateY(600px);
            }
        }

        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            font-size: 24px;
            text-shadow: 0 0 10px #00fff2, 0 0 20px #00fff2;
        }

        #player {
            position: absolute;
            width: 50px;
            height: 70px;
            bottom: 50px;
            left: 375px;
            z-index: 50;
            transition: left 0.1s ease-out;
        }

        .player-model {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #00fff2, #0051ff);
            border: 2px solid #00fff2;
            border-radius: 10px;
            box-shadow: 0 0 15px #00fff2, inset 0 0 10px rgba(255, 255, 255, 0.5);
            animation: hover 2s infinite ease-in-out;
        }

        .player-model.shield {
            box-shadow: 0 0 25px #00ff87, 0 0 40px #00ff87, inset 0 0 15px rgba(255, 255, 255, 0.7);
            border-color: #00ff87;
        }

        .player-model.dashing {
            opacity: 0.5;
            transform: scale(1.2);
            animation: dash-fx 0.3s ease-out;
        }

        @keyframes hover {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes dash-fx {
            0% { transform: scale(1.5); filter: brightness(2); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        .obstacle, .coin, .power-up {
            position: absolute;
            will-change: top;
        }

        .obstacle.block {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ff0055, #ff5555);
            border: 2px solid #ff0055;
            border-radius: 8px;
            box-shadow: 0 0 15px #ff0055;
            animation: spin 4s infinite linear;
        }

        .obstacle.laser {
            width: 100px;
            height: 10px;
            background: #ff0055;
            box-shadow: 0 0 20px #ff0055;
            animation: laser-pulse 1s infinite;
        }

        @keyframes spin {
            from { transform: rotateY(0deg) rotateX(20deg); }
            to { transform: rotateY(360deg) rotateX(20deg); }
        }

        @keyframes laser-pulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(2); }
        }

        .coin {
            width: 30px;
            height: 30px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 15px #ffd700;
            animation: pulse 1s infinite ease-in-out;
        }

        .power-up {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: cover;
            box-shadow: 0 0 20px;
            animation: power-pulse 1.5s infinite ease-in-out;
        }

        .power-up[data-type="shield"] {
            background-color: #00ff87;
            box-shadow: 0 0 20px #00ff87;
        }

        .power-up[data-type="glitch"] {
            background-color: #ff00ff;
            box-shadow: 0 0 20px #ff00ff;
        }

        .power-up[data-type="surge"] {
            background-color: #ffff00;
            box-shadow: 0 0 20px #ffff00;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes power-pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
        }

        #powerUp-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .powerup-indicator {
            padding: 10px 15px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00fff2;
            border-radius: 5px;
            text-shadow: 0 0 5px #00fff2;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 12, 29, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 1000;
        }

        .screen h1 {
            font-size: 72px;
            letter-spacing: 5px;
            color: #ff0055;
            text-shadow: 0 0 20px #ff0055;
            margin-bottom: 10px;
        }
        
        #startScreen h1 {
             color: #00fff2;
             text-shadow: 0 0 20px #00fff2;
        }

        .screen .subtitle {
            font-size: 24px;
            color: #00fff2;
            text-shadow: 0 0 10px #00fff2;
            margin-bottom: 40px;
        }

        .screen .instructions {
            margin-bottom: 40px;
        }

        .screen .instructions p {
            font-size: 18px;
            margin: 10px 0;
        }

        .screen .instructions span {
            color: #00fff2;
            padding: 5px 10px;
            border: 1px solid #00fff2;
            border-radius: 5px;
            margin-right: 10px;
        }

        .screen button {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            padding: 15px 30px;
            background: transparent;
            border: 2px solid #00fff2;
            color: #00fff2;
            border-radius: 5px;
            cursor: pointer;
            text-shadow: 0 0 10px #00fff2;
            transition: background 0.3s, color 0.3s;
        }

        .screen button:hover {
            background: #00fff2;
            color: #0d0c1d;
        }

        #gameOverScreen p {
            font-size: 28px;
            margin-bottom: 30px;
            color: #e0e1dd;
        }
    </style>

</head>
<body>
    <div id="gameContainer">
        <div class="hud">
            <div id="score">SCORE: 0</div>
            <div id="highScore">HIGH SCORE: 0</div>
        </div>
        <div id="powerUp-container"></div>
        <div id="gameArea">
            <div class="grid"></div>
            <div id="player"></div>
        </div>
        <div id="ui-layer">
            <div id="startScreen" class="screen">
                <h1>CYBER RUNNER</h1>
                <p class="subtitle">RE-ENGINEERED</p>
                <div class="instructions">
                    <p><span>&larr;</span> / <span>&rarr;</span> TO MOVE</p>
                    <p><span>SPACE</span> TO DASH</p>
                </div>
                <button id="startButton">INITIATE RUN</button>
            </div>
            <div id="gameOverScreen" class="screen" style="display: none;">
                <h1>CONNECTION LOST</h1>
                <p>FINAL SCORE: <span id="finalScore">0</span></p>
                <button id="restartButton">RESTART</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameArea = document.getElementById('gameArea');
            const playerElement = document.getElementById('player');
            const scoreDisplay = document.getElementById('score');
            const highScoreDisplay = document.getElementById('highScore');
            const powerUpContainer = document.getElementById('powerUp-container');
            const startScreen = document.getElementById('startScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const startButton = document.getElementById('startButton');
            const restartButton = document.getElementById('restartButton');
            const finalScoreDisplay = document.getElementById('finalScore');

            let gameState = {
                score: 0,
                highScore: localStorage.getItem('cyberRunnerHighScore') || 0,
                gameSpeed: 5,
                isGameOver: true,
                isPlaying: false,
                lanes: [150, 400, 650],
                currentLane: 1,
                activePowerUps: new Map()
            };

            let gameObjects = [];
            let keys = {};
            let animationFrameId;

            class Player {
                constructor() {
                    this.el = playerElement;
                    this.el.innerHTML = '<div class="player-model"></div>';
                    this.model = this.el.querySelector('.player-model');
                    this.width = 50;
                    this.isDashing = false;
                    this.dashCooldown = 2000; // 2 seconds
                    this.lastDash = -this.dashCooldown;
                }

                update() {
                    if (keys['ArrowLeft'] && gameState.currentLane > 0) {
                        gameState.currentLane--;
                        keys['ArrowLeft'] = false;
                    }
                    if (keys['ArrowRight'] && gameState.currentLane < gameState.lanes.length - 1) {
                        gameState.currentLane++;
                        keys['ArrowRight'] = false;
                    }

                    if (keys[' '] && Date.now() - this.lastDash > this.dashCooldown) {
                        this.dash();
                        keys[' '] = false;
                    }

                    this.el.style.left = (gameState.lanes[gameState.currentLane] - this.width / 2) + 'px';
                }

                dash() {
                    this.isDashing = true;
                    this.lastDash = Date.now();
                    this.model.classList.add('dashing');
                    setTimeout(() => {
                        this.isDashing = false;
                        this.model.classList.remove('dashing');
                    }, 300);
                }
            }

            class GameObject {
                constructor(type) {
                    this.type = type;
                    this.el = document.createElement('div');
                    this.el.className = this.type;
                    this.lane = Math.floor(Math.random() * gameState.lanes.length);
                    this.y = -60;
                    this.width = 60;
                    this.height = 60;
                    this.el.style.left = (gameState.lanes[this.lane] - this.width / 2) + 'px';
                    gameArea.appendChild(this.el);
                }

                update() {
                    let currentSpeed = gameState.gameSpeed;
                    if (gameState.activePowerUps.has('glitch')) {
                        currentSpeed *= 0.5;
                    }
                    this.y += currentSpeed;
                    this.el.style.top = this.y + 'px';

                    if (this.y > 600) {
                        this.destroy();
                        if (this.type === 'obstacle') {
                            updateScore(1);
                        }
                    }
                }

                destroy() {
                    if (this.el.parentElement) {
                        this.el.remove();
                    }
                    gameObjects = gameObjects.filter(o => o !== this);
                }
            }

            class Obstacle extends GameObject {
                constructor(obstacleType) {
                    super('obstacle');
                    this.obstacleType = obstacleType;
                    this.el.classList.add(this.obstacleType);

                    if (this.obstacleType === 'laser') {
                        this.width = 100;
                        this.height = 10;
                        this.el.style.left = (gameState.lanes[this.lane] - this.width / 2) + 'px';
                    }
                }
            }

            class Coin extends GameObject {
                constructor() {
                    super('coin');
                    this.width = 30;
                    this.height = 30;
                    this.el.style.left = (gameState.lanes[this.lane] - this.width / 2) + 'px';
                }
            }

            class PowerUp extends GameObject {
                constructor(powerUpType) {
                    super('power-up');
                    this.powerUpType = powerUpType;
                    this.el.dataset.type = powerUpType;
                    this.width = 40;
                    this.height = 40;
                    this.el.style.left = (gameState.lanes[this.lane] - this.width / 2) + 'px';
                }
            }
            
            const player = new Player();

            function init() {
                highScoreDisplay.textContent = `HIGH SCORE: ${gameState.highScore}`;
                startButton.addEventListener('click', startGame);
                restartButton.addEventListener('click', startGame);
                document.addEventListener('keydown', e => {
                    if (['ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                        e.preventDefault();
                    }
                    keys[e.key] = true;
                });
                document.addEventListener('keyup', e => keys[e.key] = false);
            }
            
            function startGame() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                gameState.score = 0;
                gameState.gameSpeed = 5;
                gameState.isGameOver = false;
                gameState.isPlaying = true;
                gameState.currentLane = 1;
                
                // Clear any existing powerups and timeouts
                gameState.activePowerUps.forEach(p => clearTimeout(p.timeoutId));
                gameState.activePowerUps.clear();
                
                updateScore(0);
                
                gameObjects.forEach(o => o.destroy());
                gameObjects = [];

                startScreen.style.display = 'none';
                gameOverScreen.style.display = 'none';
                
                powerUpContainer.innerHTML = '';
                player.model.classList.remove('shield');

                gameLoop();
            }

            function gameLoop() {
                if (gameState.isGameOver) {
                    return;
                }
                
                player.update();
                
                let isSurgeActive = gameState.activePowerUps.has('surge');
                
                gameObjects.forEach(o => {
                    o.update();
                    if (isSurgeActive && o.type === 'coin') {
                        const playerRect = player.el.getBoundingClientRect();
                        const coinRect = o.el.getBoundingClientRect();
                        const dx = (playerRect.left + playerRect.width/2) - (coinRect.left + coinRect.width/2);
                        const dy = (playerRect.top + playerRect.height/2) - (coinRect.top + coinRect.height/2);
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        if(distance < 200){ // Magnet range
                            o.el.style.left = (parseFloat(o.el.style.left) - dx * 0.1) + 'px';
                            o.el.style.top = (parseFloat(o.el.style.top) - dy * 0.1) + 'px';
                        }
                    }
                });

                checkCollisions();
                
                // Dynamic Spawning Logic
                if (Math.random() < gameState.score / 5000 + 0.02) spawnObject('obstacle');
                if (Math.random() < 0.015) spawnObject('coin');
                if (Math.random() < 0.002) spawnObject('power-up');

                gameState.gameSpeed = Math.min(15, 5 + gameState.score / 50);

                animationFrameId = requestAnimationFrame(gameLoop);
            }
            
            function spawnObject(type){
                if (gameState.isGameOver) return;
                
                if (type === 'obstacle') {
                    const obstacleType = Math.random() > 0.3 ? 'block' : 'laser';
                    gameObjects.push(new Obstacle(obstacleType));
                } else if (type === 'coin') {
                    gameObjects.push(new Coin());
                } else if (type === 'power-up') {
                    const powerUpTypes = ['shield', 'glitch', 'surge'];
                    const randomType = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
                    gameObjects.push(new PowerUp(randomType));
                }
            }

            function checkCollisions() {
                const playerRect = player.el.getBoundingClientRect();
                for (const obj of [...gameObjects]) { // Iterate over a copy
                    const objRect = obj.el.getBoundingClientRect();
                    if (playerRect.left < objRect.right &&
                        playerRect.right > objRect.left &&
                        playerRect.top < objRect.bottom &&
                        playerRect.bottom > objRect.top) {
                        
                        handleCollision(obj);
                    }
                }
            }
            
            function handleCollision(obj){
                if (obj.type === 'obstacle') {
                    if (player.isDashing) return;
                    if (gameState.activePowerUps.has('shield')) {
                        obj.destroy();
                        deactivatePowerUp('shield');
                        return;
                    }
                    gameOver();
                } else if (obj.type === 'coin') {
                    obj.destroy();
                    updateScore(10);
                } else if (obj.type === 'power-up') {
                    obj.destroy();
                    activatePowerUp(obj.powerUpType, 5000); // 5 second duration
                }
            }
            
            function activatePowerUp(type, duration) {
                if (gameState.activePowerUps.has(type)) {
                    clearTimeout(gameState.activePowerUps.get(type).timeoutId);
                    gameState.activePowerUps.get(type).indicator.remove();
                }

                const indicator = document.createElement('div');
                indicator.className = 'powerup-indicator';
                indicator.textContent = `${type.toUpperCase()} ACTIVE`;
                indicator.id = `indicator-${type}`;
                powerUpContainer.appendChild(indicator);
                setTimeout(() => indicator.style.opacity = '1', 10);

                const timeoutId = setTimeout(() => deactivatePowerUp(type), duration);
                gameState.activePowerUps.set(type, { timeoutId, indicator });
                
                if (type === 'shield') {
                    player.model.classList.add('shield');
                }
            }

            function deactivatePowerUp(type) {
                if (!gameState.activePowerUps.has(type)) return;

                const { indicator, timeoutId } = gameState.activePowerUps.get(type);
                clearTimeout(timeoutId);
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 500);
                
                gameState.activePowerUps.delete(type);

                if (type === 'shield') {
                    player.model.classList.remove('shield');
                }
            }

            function updateScore(amount) {
                gameState.score += amount;
                scoreDisplay.textContent = `SCORE: ${gameState.score}`;
                if (gameState.score > gameState.highScore) {
                    gameState.highScore = gameState.score;
                    highScoreDisplay.textContent = `HIGH SCORE: ${gameState.highScore}`;
                    localStorage.setItem('cyberRunnerHighScore', gameState.highScore);
                }
            }

            function gameOver() {
                gameState.isGameOver = true;
                gameState.isPlaying = false;
                cancelAnimationFrame(animationFrameId);
                finalScoreDisplay.textContent = gameState.score;
                gameOverScreen.style.display = 'flex';
            }

            init();
        });
    </script>
</body>
</html>
